# ============================================
# LOGSTASH PIPELINE FOR LLM AUDIT LOGS
# ============================================

input {
  # HTTP input for receiving logs from LLM application
  http {
    port => 5000
    codec => json
  }
  
  # TCP input as backup
  tcp {
    port => 5044
    codec => json_lines
  }
}

filter {
  # Add timestamp if missing
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Parse LLM-specific fields
  if [event_type] == "llm_request" {
    # Calculate cost based on tokens
    ruby {
      code => '
        tokens = event.get("tokens") || 0
        model = event.get("model") || "unknown"
        
        # Cost per 1K tokens
        costs = {
          "llama3.1" => 0.0002,
          "llama3.1-70b" => 0.0006,
          "gpt-4" => 0.03,
          "default" => 0.0002
        }
        
        cost_per_1k = costs[model] || costs["default"]
        cost = (tokens.to_f / 1000) * cost_per_1k
        event.set("cost_usd", cost.round(6))
      '
    }
    
    # Add compliance tags
    mutate {
      add_tag => ["llm", "audit"]
    }
  }
  
  # PII Detection
  if [prompt] {
    ruby {
      code => '
        prompt = event.get("prompt") || ""
        response = event.get("response") || ""
        text = prompt + " " + response
        
        pii_detected = false
        pii_types = []
        
        # SSN pattern
        if text =~ /\b\d{3}-\d{2}-\d{4}\b/
          pii_detected = true
          pii_types << "SSN"
        end
        
        # Credit card pattern
        if text =~ /\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/
          pii_detected = true
          pii_types << "CREDIT_CARD"
        end
        
        # Email pattern
        if text =~ /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/
          pii_detected = true
          pii_types << "EMAIL"
        end
        
        event.set("pii_detected", pii_detected)
        event.set("pii_types", pii_types)
      '
    }
  }
  
  # Security event tagging
  if [event_type] == "security_event" {
    mutate {
      add_tag => ["security", "alert"]
    }
  }
  
  # Add geo info if IP available
  if [client_ip] and [client_ip] != "127.0.0.1" {
    geoip {
      source => "client_ip"
      target => "geo"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "llm-audit-%{+YYYY.MM.dd}"
  }
  
  # Also output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}
